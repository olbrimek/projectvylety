{% extends 'vylety/base.html' %}
{% load static %}
<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seznam výletů</title>
    <link rel="stylesheet" href="{% static 'vylety/style.css' %}">
</head>
<body>
{% block content %}
    <!-- Navigační lišta -->
    <div class="navbar">
        {% if user.is_authenticated %}
            Přihlášen jako <strong>{{ user.username }}</strong> | <a href="{% url 'logout' %}">Odhlásit</a>
        {% else %}
            <a href="{% url 'login' %}">Přihlášení</a>
            <a href="{% url 'register' %}">Registrace</a>
        {% endif %}
        <!-- Výpis uživatelů -->
        <span>Uživatelé: 
            {% for u in users %}
                {{ u.username }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
        </span>
    </div>

    <!-- Nadpis -->
    <h2>Seznam výletů</h2>

    <!-- Formulář pro přidání výletu -->
    {% if user.is_authenticated and not user.is_staff and not user.is_superuser %}
        <form id="tripForm">
            <input type="text" id="name" placeholder="Název výletu" required>
            <input type="date" id="date" required>
            <input type="text" id="description" placeholder="Popis výletu" required>
            <button type="submit">Přidat výlet</button>
        </form>
    {% endif %}

    <table>
        <tr>
            <th>ID</th>
            <th>Název</th>
            <th>Datum</th>
            <th>Popis</th>
            {% if user.is_authenticated %}<th>Akce</th>{% endif %}
        </tr>
        {% for vylet in vylety %}
        <tr>
            <td>{{ vylet.id }}</td>
            <td>{{ vylet.name }}</td>
            <td>{{ vylet.date }}</td>
            <td>{{ vylet.description }}</td>
            {% if user.is_authenticated %}
            <td>
                {% if user.is_staff or user.is_superuser or vylet.user == user %}
                    <button onclick="deleteVylet({{ vylet.id }})">Smazat</button>
                {% endif %}
            </td>
            {% endif %}
        </tr>
        {% endfor %}
    </table>

    <script>
        async function deleteVylet(id) {
            await fetch(`/delete_vylet/${id}/`, { method: "DELETE" });
            location.reload();
        }
    </script>
    <script>
        const tripForm = document.getElementById("tripForm");
        if (tripForm) {
            tripForm.addEventListener("submit", async function(event) {
                event.preventDefault();

                const name = document.getElementById("name").value;
                const date = document.getElementById("date").value;
                const description = document.getElementById("description").value;

                const response = await fetch("/add_vylet/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    body: JSON.stringify({ name, date, description })
                });

                const data = await response.json();
                if (data.status === "success") {
                    location.reload();
                } else {
                    alert("Chyba: " + data.message);
                }
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
{% endblock %}
</body>
</html>